name: Leaderboard App Installation Handler

on:
  repository_dispatch:
    types: [leaderboard-bot-installed]

permissions:
  contents: read

jobs:
  handle-installation:
    runs-on: ubuntu-latest
    steps:
      - name: Show event
        run: echo "${{ toJson(github.event) }}" > event.json && cat event.json

      - name: Authenticate as GitHub App Installation (create token for the installation)
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.LEADERBOARD_BOT_ID }}
          private-key: ${{ secrets.LEADERBOARD_BOT_PRIVATE_KEY }}
          owner: ${{ github.event.client_payload.payload.installation.account.login }}

      - name: Setup secrets and variables on target repositories
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
          LEADERBOARD_BOT_ID: ${{ vars.LEADERBOARD_BOT_ID }}
          LEADERBOARD_BOT_PRIVATE_KEY: ${{ secrets.LEADERBOARD_BOT_PRIVATE_KEY }}
          GITHUB_EVENT_JSON: ${{ toJson(github.event) }}
        run: |
          set -euo pipefail

          # Read the payload from environment variable
          payload="$(echo "$GITHUB_EVENT_JSON" | jq -c '.client_payload.payload')"
          installation_id=$(echo "$payload" | jq -r '.installation.id')

          # Get list of repositories from the payload
          # Handle different event types: installation.created has .repositories, installation_repositories.added has .repositories_added
          repos=$(echo "$payload" | jq -r '(.repositories // .repositories_added // []) | .[] | .full_name')

          echo "Installation ID: $installation_id"
          echo "Repositories to configure: $repos"

          # Process each repository
          for repo_full in $repos; do
            echo "========================================="
            echo "Setting up $repo_full"
            echo "========================================="
            
            owner=$(cut -d/ -f1 <<<"$repo_full")
            repo=$(cut -d/ -f2 <<<"$repo_full")
            
            # Set the LEADERBOARD_BOT_ID as a repository variable
            echo "Setting LEADERBOARD_BOT_ID variable..."
            gh variable set LEADERBOARD_BOT_ID \
              --repo "$repo_full" \
              --body "$LEADERBOARD_BOT_ID" || {
              echo "Warning: Failed to set LEADERBOARD_BOT_ID variable for $repo_full"
            }
            
            # Set the LEADERBOARD_BOT_PRIVATE_KEY as a repository secret
            echo "Setting LEADERBOARD_BOT_PRIVATE_KEY secret..."
            echo "$LEADERBOARD_BOT_PRIVATE_KEY" | gh secret set LEADERBOARD_BOT_PRIVATE_KEY \
              --repo "$repo_full" || {
              echo "Warning: Failed to set LEADERBOARD_BOT_PRIVATE_KEY secret for $repo_full"
            }
            
            echo "âœ“ Successfully configured $repo_full"
            echo ""
          done

          echo "========================================="
          echo "Setup complete for all repositories"
          echo "========================================="
